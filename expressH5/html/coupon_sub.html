<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link href="../css/mui.min.css" rel="stylesheet" />
    <link href="../css/app.css" rel="stylesheet" />
    <style type="text/css">
        body,
        html {
            width: 100%;
			height: 100%;
            background: #EDECF2;
        }
        
        .list_wrap {
            padding: 0px;
            box-sizing: border-box;
			background-color: #F8F8F8;
			
        }
        
        .item_wrap {
            height: 0.93rem;
            width: 92%;
            margin: 0.15rem 4%;
			background-color: #FFFFFF;
			border-radius: 0.04rem;
			background-size: 100% 100%;
			padding-left: 0.15rem;
        }
		
		.item_wrap img{
			width: 0.63rem;
			height: 0.63rem;
			border-radius: 0.04rem;
		}
		
		.content_item{
			margin-left: 0.3rem;
			display: flex;
			flex-direction: column;
			justify-content: space-around;
		}
		
		.content_item .name{
			color: #333333;
			font-size: 0.14rem;
		}
		
		.content_item .time{
			color: #cccccc;
			font-size: 0.11rem;
		}
		
		.content_item .money_wrap{
			color: #ff5269;
			font-size: 0.14rem;
			font-weight: 100;
		}
		
		.content_item .money{
			color: #ff5269;
			font-size: 0.16rem;
			font-weight: 400;
		}
        
    </style>
</head>

<body>


    <div id="pullrefresh" class="mui-content mui-scroll-wrapper" style="background-color: #F8F8F8;">
        <div class="mui-scroll">
            <!--数据列表-->
            <ul class="mui-table-view-condensed list_wrap">
				<li class=" mui-table-view-cell-item row item_wrap" style="background-image: url(../images/coupon/coupon_mall.png);">
					
					<img src="../images/firstPageLive/homeBottom_03.jpg" />
					<div class="content_item">
						<span class="name">GUCCI 折扣券</span>
						<span class="time">2018-01-01 至 2018-12-31</span>
						<span class="money_wrap">
							满<span class="money">&nbsp;10000&nbsp;</span>
							减<span class="money">&nbsp;100</span>
						</span>
					</div>
					
					
				</li>
            </ul>
        </div>

    </div>
    <div class="empty_text">
        数据为空
    </div>

    <script>var h5pullDown = true;</script>
    <script src="../js/mui.js"></script>
    <script src="../js/jquery-2.1.1.min.js"></script>
    <script src="../js/app.js"></script>
    <script type="text/javascript">
        mui.init({
            pullRefresh: {
                container: '#pullrefresh',
                down: {
                    callback: pulldownRefresh
                },
                up: {
                    contentrefresh: '正在加载...',
                    callback: pullupRefresh
                }
            }
        });

        mui.plusReady(function() {
            // pulldownRefresh();

            //点击上次浏览
            window.addEventListener('updateCouponType', function(event) {
                console.log("收到事件" + event.detail.index);
                updateClick(event.detail.index);
            }, false);

        });


        // pulldownRefresh();
		var tabIndex = 0;
        function updateClick(index) {
			tabIndex = index;
            findList = [];
            pulldownRefresh();
        }

        /**
         * 下拉刷新具体业务实现
         */
        function pulldownRefresh() {
            current = 1;
            findList = [];

            getMsglist(0);
        }

        /**
         * 上拉加载具体业务实现
         */
        function pullupRefresh() {
            current++;
            getMsglist(1);
        }

        //当前查询  页数
        var current = 1;

        function getMsglist(refreshType) {
            var params = {
                current: current,
                size: 20
            };

            $(".empty_text").hide();
            $("#pullrefresh").show();
			//mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
			
			
			setTimeout(function(){
				getListData(0, [1,2,3], false);
			}, 1000);
			return;
            Global.commonAjax({
                    url: "goods/payed/goodslist",
                    method: "POST",
                    data: params
                },
                function(data) {
                    if (data.current >= data.pages) {
                        if ((data.current == 1) && (data.records.length == 0)) {
                            //空数据
                            $(".empty_text").show();
                            $("#pullrefresh").hide();
                            mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
                        } else {
                            //没有更多数据了
                            getListData(refreshType, data.records, true);
                        }
                    } else {
                        getListData(refreshType, data.records, false);
                    }
                },
                function(err) {
                    mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
                }
            )
        }

        var findList = [];

        function getListData(refreshType, cells, isAll) {
            findList = findList.concat(cells);
            mui('#pullrefresh').pullRefresh().refresh(true);
            //当前点击的 数据下标
            var index = 0;
            var table = document.body.querySelector('.mui-table-view-condensed');

            if (refreshType == 0) {
                //下拉刷新
                table.innerHTML = "";
                $(".mui-table-view-condensed").html = "";

                if (mui.os.android) {
                    $('html, body').animate({
                        scrollTop: -$(".mui-table-view-condensed").offset().top
                    }, 20);
                } else {
                    mui('#pullrefresh').scroll().scrollTo(0, 0);
                }


            } else {
                //加载更多
                mui('#pullrefresh').pullRefresh().endPullupToRefresh(isAll); //参数为true代表没有更多数据了。
                var preList = document.body.querySelectorAll('.mui-table-view-cell-item');
                index = preList == null ? 0 : preList.length;
            }

            for (var i = 0, len = cells.length; i < len; i++) {
                var li = document.createElement('li');
                var item = cells[i];

                li.className = 'mui-table-view-cell-item row item_wrap';
                li.setAttribute("data-index", index);
                
				li.innerHTML = '<img src="../images/firstPageLive/homeBottom_03.jpg" />'+
					'<div class="content_item">'+
						'<span class="name">GUCCI 折扣券</span>'+
						'<span class="time">2018-01-01 至 2018-12-31 </span>'+
						'<span class="money_wrap">'+
							'满<span class="money">&nbsp;10000&nbsp;</span>'+
							'减<span class="money">&nbsp;100</span>'+
						'</span></div>';
					
                table.appendChild(li);

                index += 1;

            }

            if (refreshType == 0) {
                //下拉刷新
                mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
            } else {
                //上拉加载
                if (cells.length < 20) {
                    mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                }
            }
        }



        // $('body').on('click', '.mui-table-view-condensed li', function() {
        mui(".mui-table-view-condensed").on('tap', 'li ', function() {

            var index = $(this).data("index");
            $(this).addClass("clicked");
            var item = findList[index];
            if (!(item && item.goodsUrl)) {
                return;
            }
            var clickType = {
                source: myStorage.getItem("user").sourceCode,
                goodsCode: item.goodsCode,
                page: "payed"
            }
            plus.statistic.eventTrig("loansgoods", JSON.stringify(clickType))
			
			if (mui.os.android) {
				clickFindItem(item);
				return;
			        checkPermissionPhoto(function() {
			            clickFindItem(item);
			        }, function() {
			            var btnArray = ['去设置','取消'];
			            var mainAct = plus.android.runtimeMainActivity();
	                    mui.confirm("请在设置里面允许权限", '提示', btnArray, function(e) {
	                        if (e.index == 0) {
	                            //去设置
	                            plus.android.invoke("org.qldc.xianghq.Tools", "goToSetting", mainAct);
	                        }
	                    })
			        });
			    } else {

                plus.plugintest.PluginXcqxFunction("Html5", "Plus", "AsyncFunction", "MultiArgument!", function(result) {
                    //alert( result[0].toString());

                    if(result[0]=="1")
                    {
                        clickFindItem(item);


                    }
                    else
                    {


                        var btnArray = ['取消', '设置'];
                        mui.confirm('在设备的"设置-隐私-相机"中允许访问相机', '提示', btnArray, function(e) {
                            if (e.index == 1) {

                                var UIApplication = plus.ios.import("UIApplication");
                                var NSURL = plus.ios.import("NSURL");
                                var setting = NSURL.URLWithString("app-settings:");
                                var application = UIApplication.sharedApplication();
                                application.openURL(setting);
                                plus.ios.deleteObject(setting);
                                plus.ios.deleteObject(application);

                            } else {




                            }
                        })


                    }


                }, function(result) {
                    //alert(result)
                });
			
			
			    }
    
    
            
        });
        
        
        function clickFindItem(item){
        		var params = {
                goodsCode: item.goodsCode
            }
            Global.commonAjax({
                    url: "goods/click",
                    data: params,
                    method: "POST"
                },
                function(data) {
                		if(mui.os.android && (item.jumpType == "out")){
		        			plus.runtime.openURL(item.goodsUrl);
		        			return;
		        		}
                    Global.openWindow({
                        url: 'webview.html',
                        id: 'webview.html?url=' + item.goodsUrl,
                        waiting: {
                            autoShow: false
                        },
                        extras: {
                            title: item.goodsTitle
                        }
                    })
                },
                function(err) {

                }
            )
        }
    </script>
</body>

</html>