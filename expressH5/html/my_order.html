<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/app.css" rel="stylesheet" />
		<style type="text/css">
			body, html{
				width: 100%;
				height: 90%;
				background: #F2F2F2;
			}
			
			.select_type{
				height: 45px;
				align-items: center;
				justify-content: space-around;
				background: #ffffff;
				color: #666666;
				font-size: 16px;
				position: fixed;
				width: 100%;
				box-sizing: border-box;
			}
			
			.active{
				color: #333333;
				font-weight: bold;
			}
			
			.mui-progressbar{
				height: 16px;
				border-radius: 10px;
				background: #FFD9D6;
			}
			.mui-progressbar span{
				background: #Ff5445;
				border-radius: 10px;
			}
			
			.empty_text{
				width: 100%; 
				height: 400px; 
				line-height: 400px; 
				text-align: center;
				background: #f4f4f4; 
				border: none; 
				z-index: 10;
				background: #f2f2f2;
			}
			
			.active_line{
				height: 4px;
				width: 20px;
				background-color: #107EFF;
				border-radius: 4px;
				position: absolute;
				bottom: 0px;
				left: 50%;
				margin-left: -10px;
			}
			
			.item{
				height: 47px;
				position: relative;
			}

		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" >
		    <img src="../images/back.png" class="mui-action-back">
		    <h1 class="mui-title">我的订单</h1>
		</header>
		
		<div class="mui-content" style="text-align: center; background: #F2F2F2;">
			<div class="row select_type">
				<div class="col_center item" onclick="changeType(0)">
					<span class="titleType active" >全部</span>
					<span class="active_line"></span>
				</div>
				
				<div class="col_center item" onclick="changeType(1)">
					<span class="titleType" >待付款</span>
					<span class=""></span>
				</div>
				
				<div class="col_center item" onclick="changeType(2)">
					<span class="titleType" >待发货</span>
					<span class=""></span>
				</div>
				
				<div class="col_center item" onclick="changeType(3)">
					<span class="titleType" >待收货</span>
					<span class=""></span>
				</div>
				
			</div>
		</div>
		
		
		<div id="pullrefresh" class=" mui-scroll-wrapper" 
					style="margin-top:0.9rem; border-top: 1px solid #E3E3E3;">
		    <div class="mui-scroll" >
		        <!--数据列表-->
		        <ul class="mui-table-view-condensed list_wrap" >
					
		        </ul>
		    </div>
		
		</div>
		<div class="empty_text hideClass">
		    数据为空
		</div>
		
		
		<script src="../js/mui.js"></script>
		<script src="../js/jquery-2.1.1.min.js"></script>
		 <script src="../js/app.js"></script> 
		 <script src="../js/myStorage.js"></script>
		<script type="text/javascript">
			var h5pullDown = true;
			
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						callback: pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});
			
			if (mui.os.plus) {
				mui.plusReady(function() {
					setTimeout(function () {
					    mui.focus(document.getElementById('searchInput'));
					    $('#searchInput').focus()
					}, 150);
			
					getMsglist();
					
					window.addEventListener('searchType', function(event) {
					    console.log("收到事件" + event.detail.search);
					    pulldownRefresh();
					}, false);
			
				});
			} else {
				mui.ready(function() {
					
					mui.focus(document.getElementById('searchInput'));
					$('#searchInput').focus();
					getMsglist();
					
					window.addEventListener('searchType', function(event) {
					    console.log("收到事件" + event.detail.search);
					    pulldownRefresh();
					}, false);
					
				});
			}
			
			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				current=1;
				mui('#pullrefresh').pullRefresh().refresh(true);
				$(".list_wrap").empty();
				findList = [];
				getMsglist();
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				setTimeout(function() {
					getMsglist();
				}, 500);
			}
			
			
			//当前查询  页数
			var current = 1;
			var isEnd = 0;
			var findList = [];
			
			function changeType(index){
				$(".titleType").each(function(ind){
					$(this).removeClass("active");
					$(this).next().removeClass("active_line");
					
					if(index == ind){
						$(this).addClass("active");
						$(this).next().addClass("active_line");
						sendClickType(index);
					}
				})
			}
				
			function sendClickType(index){
				console.log("发送事件"+index);
				var h = plus.webview.getWebviewById("my_order_sub.html");
				mui.fire(h,'updateOrderType',{index: index});
			}
			
			
			function getMsglist() {
				var searchKey = $("#searchInput").val();
				var params = {
					"q": searchKey
				};
	
				$(".empty_text").hide();
				$("#pullrefresh").show();
				//mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
				
				console.log("进入页面："+myStorage.getItem("storageSelectAddressValue"));
				
				var typeValue=myStorage.getItem("storageSelectAddressValue");
				var url=searchKey ? "addresses/search?q="+searchKey+"&page="+current : "addresses?type=1&page="+current;
				if(typeValue>0)
				{
					if(typeValue==1)
					{
						url=searchKey ? "addresses/search?type=1&q="+searchKey+"&page="+current : "addresses?type=1&page="+current;
					}
					else
					{
						url=searchKey ? "addresses/search?type=2&q="+searchKey+"&page="+current : "addresses?type=2&page="+current;
					}
				}
				
				Global.commonAjax({
						url: url
						
					},
					function(data) {
						if(data){
							var html = "";
							var res = data;
							if(searchKey){
								res = data;
							}else{
								res = data.data;
							}
							console.log(res);
							
							if(res.length > 0){
								for(var i=0;i<res.length;i++){
									var item = res[i];
									findList = findList.concat(item);
									html += '<li class="mui-table-view-cell-item item_wrap col_between" data-index="'+i+'">'+
											'<div class="row_between wrap">'+
											'<span class="sex">'+item.name.substring(0,1)+'</span>'+
											'<div class="content_wrap">'+
												'<span class="name">'+item.name+
													' &nbsp;&nbsp;<span class="tel">'+item.mobile+'</span>'+
												'</span>'+
												'<span class="address">'+item.province+item.city+item.area+item.detail+'</span>'+
											'</div>'+
											'<img class="edit-img" src="../images/address/edit_address_icon.png" >'+
										'</div></li>';
								}
								current ++;
								$(".list_wrap").append(html);
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
							}else{
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
							}
							if(current==1&&res.length==0)
							{
								$(".empty_text").removeClass("hideClass");
							}
						}
					},
					function(err) {
						mui.toast(err);
// 							isEnd=1;
// 						    mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					})
					
			}
	
			
		</script>
	</body>

</html>